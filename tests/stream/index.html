<!doctype html>
<html lang="de">
    <head>
        <meta charset="utf-8" />
        <title>stream test</title>
        <script>
            window.addEventListener('load', e => {
                let model = 'chatgpt',
                    prompt = 'Erzähle einen Witz über Computer.',
                    url = 'stream.php?model=' + model + '&prompt=' + encodeURIComponent(prompt),
                    source = new EventSource(url),
                    content = '',
                    $container = document.querySelector('.container'),
                    curIndex = 0,
                    typing = () => {
                        let speed = 100;
                        if (curIndex < content.length) {
                            speed = Math.max(1, Math.round(1000 / (content.length - curIndex)));
                            $container.textContent += content.charAt(curIndex);
                            curIndex++;
                        }
                        setTimeout(typing, speed);
                    };
                source.onmessage = event => {
                    if (event.data === '[DONE]') {
                        source.close();
                        return;
                    }
                    let data = JSON.parse(event.data);
                    if (data.id && data.choices && data.choices.length > 0 && data.choices[0].delta.content) {
                        content += data.choices[0].delta.content;
                    }
                };
                source.onerror = error => {
                    console.error('Error:', error);
                    source.close();
                };
                typing();
            });
        </script>
    </head>
    <body>
        <div class="container"></div>
    </body>
</html>
