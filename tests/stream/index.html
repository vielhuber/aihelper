<!doctype html>
<html lang="de">
    <head>
        <meta charset="utf-8" />
        <title>stream test</title>
        <style>
            .container {
                white-space: pre-wrap;
            }
        </style>
        <script>
            window.addEventListener('load', e => {
                if (document.querySelector('.container') !== null) {
                    document.querySelectorAll('.container').forEach($container => {
                        let prompt = 'Erzähle einen Witz mit ca. 100 Zeichen über das Thema "Computer".',
                            url =
                                'stream.php?prompt=' +
                                encodeURIComponent(prompt) +
                                '&provider=' +
                                $container.getAttribute('data-provider') +
                                '&model=' +
                                $container.getAttribute('data-model') +
                                '&api_key=' +
                                $container.getAttribute('data-api-key') +
                                '&log=' +
                                $container.getAttribute('data-log'),
                            source = new EventSource(url),
                            content = '',
                            curIndex = 0,
                            isStarted = false,
                            isLoaded = false,
                            isRendered = false,
                            typing = () => {
                                let speed = 100;
                                if (content === '') {
                                    if ($container.textContent.length >= 3) {
                                        $container.textContent = '';
                                    }
                                    $container.textContent += '.';
                                } else {
                                    if (isStarted === false) {
                                        isStarted = true;
                                        $container.textContent = '';
                                    }

                                    if (curIndex < content.length) {
                                        speed = Math.max(1, Math.round(500 / (content.length - curIndex)));
                                        $container.textContent = content.substring(0, curIndex + 1) + '⏳';
                                        curIndex++;
                                    } else {
                                        $container.textContent = content + (!isLoaded ? '⏳' : '');
                                        if (isLoaded) {
                                            isRendered = true;
                                        }
                                    }
                                }
                                if (isRendered === false) {
                                    setTimeout(typing, speed);
                                }
                            };
                        source.onmessage = event => {
                            if (event.data === '[DONE]') {
                                isLoaded = true;
                                source.close();
                                return;
                            }
                            let data = JSON.parse(event.data);
                            if (data.id && data.choices && data.choices.length > 0 && data.choices[0].delta.content) {
                                content += data.choices[0].delta.content;
                            }
                        };
                        source.onerror = error => {
                            console.error('Error:', error);
                            source.close();
                            isLoaded = true;
                            isRendered = true;
                            setTimeout(() => {
                                $container.innerHTML = '<em style="color: red;">Connection error</em>';
                            }, 1000);
                        };
                        typing();
                    });
                }
            });
        </script>
    </head>
    <body>
        <h2>claude-haiku-4-5</h2>
        <div
            class="container"
            data-provider="claude"
            data-model="claude-haiku-4-5"
            data-api-key="CLAUDE_API_KEY"
            data-log="stream-claude.log"
        ></div>
        <h2>gpt-5-mini</h2>
        <div
            class="container"
            data-provider="chatgpt"
            data-model="gpt-5-mini"
            data-api-key="CHATGPT_API_KEY"
            data-log="stream-chatgpt.log"
        ></div>
        <h2>test</h2>
        <div
            class="container"
            data-provider="test"
            data-model="test-model-1"
            data-api-key=""
            data-log="stream-test.log"
        ></div>
    </body>
</html>
